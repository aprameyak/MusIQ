name: Discord Issue Creator

on:
  repository_dispatch:
    types: [discord-issue-created]

permissions:
  contents: read
  issues: write

jobs:
  create-issue:
    name: Create GitHub Issue from Discord
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract issue data
        id: extract
        run: |
          echo "title=$(echo '${{ github.event.client_payload.title }}' | sed 's/"/\\"/g')" >> $GITHUB_OUTPUT
          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.client_payload.description }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "type=${{ github.event.client_payload.type }}" >> $GITHUB_OUTPUT
          echo "discord_user_id=${{ github.event.client_payload.discord_user_id }}" >> $GITHUB_OUTPUT
          echo "discord_username=${{ github.event.client_payload.discord_username }}" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = `${{ steps.extract.outputs.title }}`;
            const description = `${{ steps.extract.outputs.description }}`;
            const type = `${{ steps.extract.outputs.type }}`;
            const discordUserId = `${{ steps.extract.outputs.discord_user_id }}`;
            const discordUsername = `${{ steps.extract.outputs.discord_username }}`;
            
            const issueBody = `${description}\n\n---\n*Created from Discord by ${discordUsername} (${discordUserId})*`;
            
            const labels = [type];
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: issueBody,
              labels: labels
            });
            
            console.log(`Issue #${issue.data.number} created: ${issue.data.html_url}`);
            
            core.setOutput('issue_number', issue.data.number);
            core.setOutput('issue_url', issue.data.html_url);
